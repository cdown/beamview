jobs:
  build_and_test:
    name: CI
    runs-on: ubuntu-latest
    strategy:
      matrix:
        want_x11: [true, false]

    steps:
      - uses: actions/checkout@v3

      - name: Add Ubuntu toolchain PPA
        run: sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test

      - name: Update apt cache
        run: sudo apt-get update

      - name: Install build dependencies
        run: |
          sudo apt-get install -y \
            gcc-10 \
            clang \
            clang-tidy \
            pkg-config \
            libsdl2-dev \
            libpoppler-glib-dev \
            libcairo2-dev \
            libglib2.0-dev \
            $( if [ "${{ matrix.want_x11 }}" = "true" ]; then echo "libx11-dev"; fi )

      - name: Verify compiler
        run: gcc --version

      - name: Build (release)
        run: make clean all WANT_X11=${{ matrix.want_x11 && '1' || '0' }}

      - name: Run clang-tidy
        run: make clean clang-tidy WANT_X11=${{ matrix.want_x11 && '1' || '0' }}

on:
  push:
  pull_request:
  workflow_dispatch:

